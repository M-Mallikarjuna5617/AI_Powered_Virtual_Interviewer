<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical Assessment - Coding Challenge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --hr-green: #39424e;
            --hr-dark: #0d141e;
            --hr-darker: #06090f;
            --hr-accent: #1ba94c;
            --hr-success: #00b8a3;
            --hr-danger: #ef4743;
            --hr-warning: #ffb800;
            --hr-text: #fff;
            --hr-text-muted: #9b9b9b;
            --hr-border: #2c3e50;
        }

        body {
            background: var(--hr-dark);
            color: var(--hr-text);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        /* Top Navigation Bar */
        .top-nav {
            background: var(--hr-darker);
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid var(--hr-border);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--hr-accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .company-name {
            font-size: 0.9rem;
            color: var(--hr-text-muted);
            border-left: 2px solid var(--hr-border);
            padding-left: 15px;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .timer-badge {
            background: linear-gradient(135deg, var(--hr-accent), var(--hr-success));
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
        }

        .timer-badge.warning {
            background: linear-gradient(135deg, var(--hr-danger), #c0392b);
            animation: pulse 1.5s infinite;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 45% 55%;
            height: calc(100vh - 50px);
            margin-top: 50px;
        }

        /* Left Panel - Problem Description */
        .problem-panel {
            background: var(--hr-green);
            overflow-y: auto;
            border-right: 1px solid var(--hr-border);
        }

        .problem-header {
            padding: 20px;
            border-bottom: 1px solid var(--hr-border);
            background: var(--hr-darker);
        }

        .problem-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .problem-tab {
            padding: 8px 16px;
            background: var(--hr-green);
            border: 1px solid var(--hr-border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .problem-tab:hover {
            border-color: var(--hr-accent);
        }

        .problem-tab.active {
            background: var(--hr-accent);
            border-color: var(--hr-accent);
            color: white;
        }

        .problem-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .problem-meta {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .difficulty-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .difficulty-easy {
            background: #d4edda;
            color: #155724;
        }

        .difficulty-medium {
            background: #fff3cd;
            color: #856404;
        }

        .difficulty-hard {
            background: #f8d7da;
            color: #721c24;
        }

        .score-badge {
            background: var(--hr-darker);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        .question-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--hr-text-muted);
        }

        .question-navigation-buttons {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            justify-content: center;
        }

        .btn-nav {
            padding: 10px 20px;
            border: 1px solid var(--hr-border);
            background: var(--hr-green);
            color: var(--hr-text);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-nav:hover:not(:disabled) {
            background: var(--hr-accent);
            border-color: var(--hr-accent);
        }

        .btn-nav:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-next {
            background: var(--hr-accent);
            color: white;
        }

        .btn-next:hover:not(:disabled) {
            background: var(--hr-success);
        }

        .problem-content {
            padding: 25px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 25px 0 15px 0;
            color: var(--hr-accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .problem-description {
            line-height: 1.8;
            color: #e1e1e1;
            margin-bottom: 20px;
        }

        .code-block {
            background: var(--hr-darker);
            border: 1px solid var(--hr-border);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 10px 0;
            overflow-x: auto;
        }

        .example-box {
            background: var(--hr-darker);
            border-left: 4px solid var(--hr-accent);
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .example-label {
            font-weight: 600;
            color: var(--hr-accent);
            margin-bottom: 8px;
        }

        /* Right Panel - Code Editor */
        .editor-panel {
            display: flex;
            flex-direction: column;
            background: var(--hr-darker);
        }

        .editor-header {
            background: var(--hr-darker);
            padding: 10px 20px;
            border-bottom: 1px solid var(--hr-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .language-select {
            background: var(--hr-green);
            color: var(--hr-text);
            border: 1px solid var(--hr-border);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .language-select:focus {
            outline: none;
            border-color: var(--hr-accent);
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        .btn-editor {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-run {
            background: var(--hr-green);
            color: var(--hr-text);
            border: 1px solid var(--hr-border);
        }

        .btn-run:hover {
            background: var(--hr-accent);
            border-color: var(--hr-accent);
        }

        .btn-submit {
            background: var(--hr-accent);
            color: white;
        }

        .btn-submit:hover {
            background: var(--hr-success);
            transform: translateY(-1px);
        }

        .btn-editor:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .editor-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #monaco-editor {
            width: 100%;
            height: 100%;
        }

        /* Bottom Panel - Output/Test Cases */
        .output-panel {
            background: var(--hr-green);
            border-top: 1px solid var(--hr-border);
            min-height: 200px;
            max-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .output-tabs {
            display: flex;
            background: var(--hr-darker);
            border-bottom: 1px solid var(--hr-border);
        }

        .output-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .output-tab:hover {
            background: var(--hr-green);
        }

        .output-tab.active {
            border-bottom-color: var(--hr-accent);
            color: var(--hr-accent);
        }

        .output-content {
            padding: 15px 20px;
            overflow-y: auto;
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .test-case-item {
            background: var(--hr-darker);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid var(--hr-border);
        }

        .test-case-item.passed {
            border-left-color: var(--hr-success);
        }

        .test-case-item.failed {
            border-left-color: var(--hr-danger);
        }

        .test-case-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .test-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .test-status.passed {
            color: var(--hr-success);
        }

        .test-status.failed {
            color: var(--hr-danger);
        }

        .test-details {
            font-size: 0.85rem;
            color: var(--hr-text-muted);
        }

        .console-output {
            background: var(--hr-darker);
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .error-output {
            color: var(--hr-danger);
        }

        .success-output {
            color: var(--hr-success);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--hr-darker);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--hr-border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Success Modal */
        .success-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .success-modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--hr-green);
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 500px;
            border: 2px solid var(--hr-accent);
        }

        .success-icon {
            font-size: 4rem;
            color: var(--hr-success);
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .modal-score {
            font-size: 3rem;
            font-weight: 700;
            color: var(--hr-accent);
            margin: 20px 0;
        }

        .btn-modal {
            background: var(--hr-accent);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
        }

        .btn-modal:hover {
            background: var(--hr-success);
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <div class="top-nav">
        <div class="nav-left">
            <div class="logo">
                <i class="fas fa-code"></i>
                <span>TechAssess</span>
            </div>
            <div class="company-name" id="companyName">Loading...</div>
        </div>
        <div class="nav-right">
            <div class="timer-badge" id="timerBadge">
                <i class="fas fa-clock"></i>
                <span id="timerDisplay">60:00</span>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel - Problem Description -->
        <div class="problem-panel">
            <div class="problem-header">
                <div class="problem-tabs" id="problemTabs">
                    <!-- Tabs will be generated here -->
                </div>
                <div class="question-navigation">
                    <span id="currentQ">1</span> / <span id="totalQ">2</span>
                    <span id="questionProgress">Question 1 of 2</span>
                </div>
                <h1 class="problem-title" id="questionTitle">Loading Problem...</h1>
                <div class="problem-meta">
                    <span class="difficulty-badge difficulty-medium" id="difficultyBadge">Medium</span>
                    <span class="score-badge"><i class="fas fa-star"></i> <span id="scoreBadge">50 points</span></span>
                </div>
            </div>

            <div class="problem-content">
                <div class="section-title">
                    <i class="fas fa-book"></i>
                    Problem Description
                </div>
                <div class="problem-description" id="questionDescription">
                    Loading problem description...
                </div>

                <div class="section-title">
                    <i class="fas fa-arrow-down"></i>
                    Input Format
                </div>
                <div class="code-block" id="inputFormat">Loading...</div>

                <div class="section-title">
                    <i class="fas fa-arrow-up"></i>
                    Output Format
                </div>
                <div class="code-block" id="outputFormat">Loading...</div>

                <div class="section-title">
                    <i class="fas fa-list-check"></i>
                    Constraints
                </div>
                <div class="problem-description" id="constraints">Loading...</div>

                <!-- Navigation Buttons -->
                <div class="question-navigation-buttons">
                    <button class="btn-nav" id="prevBtn" onclick="previousQuestion()" disabled>
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button class="btn-nav btn-next" id="nextBtn" onclick="nextQuestion()">
                        Next Question <i class="fas fa-arrow-right"></i>
                    </button>
                </div>

                <div class="section-title">
                    <i class="fas fa-flask"></i>
                    Sample Test Cases
                </div>
                <div id="examplesContainer">
                    <!-- Examples will be generated here -->
                </div>
            </div>
        </div>

        <!-- Right Panel - Code Editor -->
        <div class="editor-panel">
            <div class="editor-header">
                <div class="editor-controls">
                    <select class="language-select" id="languageSelect" onchange="changeLanguage()">
                        <option value="python">Python</option>
                        <option value="java">Java</option>
                        <option value="cpp">C++</option>
                        <option value="javascript">JavaScript</option>
                    </select>
                    <span style="color: var(--hr-text-muted); font-size: 0.85rem;">
                        <i class="fas fa-keyboard"></i> Press Ctrl+Enter to run
                    </span>
                </div>
                <div class="editor-actions">
                    <button class="btn-editor btn-run" id="runBtn" onclick="runCode()">
                        <i class="fas fa-play"></i> Run Code
                    </button>
                    <button class="btn-editor btn-submit" id="submitBtn" onclick="submitCode()">
                        <i class="fas fa-paper-plane"></i> Submit
                    </button>
                </div>
            </div>

            <div class="editor-wrapper">
                <div id="monaco-editor"></div>
            </div>

            <div class="output-panel">
                <div class="output-tabs">
                    <div class="output-tab active" onclick="switchOutputTab('testcases')">
                        <i class="fas fa-vials"></i> Test Cases
                    </div>
                    <div class="output-tab" onclick="switchOutputTab('console')">
                        <i class="fas fa-terminal"></i> Console
                    </div>
                </div>
                <div class="output-content" id="outputContent">
                    <div style="color: var(--hr-text-muted); text-align: center; padding: 40px;">
                        <i class="fas fa-code" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Run your code to see test results</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="successModal">
        <div class="modal-content">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="modal-title">Submission Successful!</div>
            <div class="modal-score" id="modalScore">85/100</div>
            <p style="color: var(--hr-text-muted); margin-bottom: 25px;">
                All solutions have been submitted successfully.
            </p>
            <button class="btn-modal" onclick="window.location.href='/dashboard'">
                <i class="fas fa-home"></i> Back to Dashboard
            </button>
            <button class="btn-modal" onclick="closeSuccessModal()">
                <i class="fas fa-redo"></i> Review Solutions
            </button>
        </div>
    </div>

    <script>
/* ---------- CONFIG ---------- */
let currentQuestionIndex = 0;
let attemptId = null;
let timeRemaining = 3600; // 1 hour
let timerInterval;
let testStartTime = Date.now();
let testCompleted = false;
let questions = [];
let editor = null;
let currentLanguage = 'python';
let questionCodes = {}; // Store code for each question

/* ---------- INITIALIZE TEST ---------- */
async function initTest() {
    try {
        console.log("üîÑ Starting technical interview...");
        const response = await fetch('/technical/start', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin'
        });
        const data = await response.json();

        if (data.success) {
            attemptId = data.attempt_id;
            questions = data.questions;
            timeRemaining = data.time_limit || 3600;

            console.log(`‚úÖ Started technical interview with ${questions.length} questions`);
            document.getElementById("companyName").textContent = data.company;
            document.getElementById("totalQ").textContent = questions.length;
            document.getElementById("questionProgress").textContent = `Question 1 of ${questions.length}`;

            // Initialize Monaco Editor
            initMonacoEditor();

            loadQuestion(0);
            startTimer();
        } else {
            throw new Error(data.error || "Failed to start technical interview.");
        }
    } catch (err) {
        console.error("‚ùå Technical interview initialization failed:", err);
        alert("Could not load questions. Please refresh or try again later.");
    }
}

/* ---------- MONACO EDITOR ---------- */
function initMonacoEditor() {
    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
    require(['vs/editor/editor.main'], function() {
        editor = monaco.editor.create(document.getElementById('monaco-editor'), {
            value: '',
            language: currentLanguage,
            theme: 'vs-dark',
            fontSize: 14,
            minimap: { enabled: false },
            scrollBeyondLastLine: false,
            automaticLayout: true,
            wordWrap: 'on'
        });

        // Add keyboard shortcut for running code
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, function() {
            runCode();
        });
    });
}

/* ---------- LOAD QUESTION ---------- */
function loadQuestion(index) {
    if (index >= questions.length) return showResults();
    const q = questions[index];

    // Save current code before switching
    if (editor && currentQuestionIndex >= 0) {
        questionCodes[questions[currentQuestionIndex].id] = editor.getValue();
    }

    currentQuestionIndex = index;

    document.getElementById("currentQ").textContent = index + 1;
    document.getElementById("questionProgress").textContent = `Question ${index + 1} of ${questions.length}`;
    document.getElementById("difficultyBadge").textContent = q.difficulty;
    document.getElementById("difficultyBadge").className = `difficulty-badge ${q.difficulty.toLowerCase()}`;

    // Update question content
    document.getElementById("questionTitle").textContent = q.title;
    document.getElementById("questionDescription").textContent = q.description;
    document.getElementById("inputFormat").textContent = q.input_format;
    document.getElementById("outputFormat").textContent = q.output_format;
    document.getElementById("constraints").textContent = q.constraints;

    // Set code in editor (saved code or starter code)
    if (editor) {
        const savedCode = questionCodes[q.id];
        editor.setValue(savedCode || q.starter_code || '');
        monaco.editor.setModelLanguage(editor.getModel(), currentLanguage);
    }

    // Update navigation buttons
    document.getElementById("prevBtn").disabled = index === 0;
    const nextBtn = document.getElementById("nextBtn");
    nextBtn.innerHTML = index === questions.length - 1
        ? 'Submit All<i class="fas fa-check ms-2"></i>'
        : 'Next Question<i class="fas fa-arrow-right ms-2"></i>';

    // Clear output
    document.getElementById("outputContent").innerHTML = `
        <div style="color: var(--hr-text-muted); text-align: center; padding: 40px;">
            <i class="fas fa-code" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
            <p>Write your code and run tests to see results</p>
        </div>`;
}

/* ---------- NAVIGATION ---------- */
function nextQuestion() {
    if (currentQuestionIndex < questions.length - 1) {
        loadQuestion(++currentQuestionIndex);
    } else {
        showResults();
    }
}

function previousQuestion() {
    if (currentQuestionIndex > 0) loadQuestion(--currentQuestionIndex);
}

function changeLanguage() {
    currentLanguage = document.getElementById("languageSelect").value;
    if (editor) {
        monaco.editor.setModelLanguage(editor.getModel(), currentLanguage);
    }
}

/* ---------- TIMER ---------- */
function startTimer() {
    timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            alert("‚è∞ Time is up! Submitting interview...");
            showResults();
        }
    }, 1000);
}

function updateTimerDisplay() {
    const hours = Math.floor(timeRemaining / 3600);
    const min = Math.floor((timeRemaining % 3600) / 60);
    const sec = timeRemaining % 60;
    const timerEl = document.getElementById("timerDisplay");
    timerEl.textContent = `${hours.toString().padStart(2, "0")}:${min.toString().padStart(2, "0")}:${sec.toString().padStart(2, "0")}`;
    const timerBadge = document.getElementById("timerBadge");
    timerBadge.className = "timer-badge";
    if (timeRemaining <= 300) timerBadge.classList.add("danger");
    else if (timeRemaining <= 600) timerBadge.classList.add("warning");

    // const progress = ((3600 - timeRemaining) / 3600) * 100;
    // document.getElementById("progressFill").style.width = `${progress}%`;
}

/* ---------- CODE EXECUTION ---------- */
async function runCode() {
    if (!editor) return;

    const runBtn = document.getElementById("runBtn");
    const originalText = runBtn.innerHTML;
    runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
    runBtn.disabled = true;

    try {
        const code = editor.getValue();
        const questionId = questions[currentQuestionIndex].id;

        const response = await fetch('/technical/run-code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                code: code,
                question_id: questionId,
                language: currentLanguage
            })
        });

        const data = await response.json();

        if (data.success) {
            displayTestResults(data.result);
        } else {
            showError(data.error || "Code execution failed");
        }
    } catch (err) {
        console.error("‚ùå Code execution failed:", err);
        showError("Failed to execute code. Please try again.");
    } finally {
        runBtn.innerHTML = originalText;
        runBtn.disabled = false;
    }
}

function displayTestResults(result) {
    let output = '<div class="test-results">';

    if (result.error) {
        output += `<div class="error-output">${result.error}</div>`;
    } else {
        output += `<div class="success-output">‚úì Code executed successfully</div>`;
        if (result.passed !== undefined && result.total !== undefined) {
            output += `<div class="test-summary">
                <strong>Test Results:</strong> ${result.passed}/${result.total} tests passed
            </div>`;
        }
    }

    if (result.output) {
        output += `<div class="console-output">${result.output}</div>`;
    }

    output += '</div>';
    document.getElementById("outputContent").innerHTML = output;
    switchOutputTab('testcases');
}

function showError(message) {
    document.getElementById("outputContent").innerHTML = `
        <div class="error-output">${message}</div>
    `;
}

/* ---------- SUBMISSION ---------- */
async function submitCode() {
    if (!editor || !attemptId) return;

    const submitBtn = document.getElementById("submitBtn");
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    submitBtn.disabled = true;

    try {
        // Save current code before submitting
        if (editor && currentQuestionIndex >= 0) {
            questionCodes[questions[currentQuestionIndex].id] = editor.getValue();
        }

        const solutions = questions.map(q => ({
            question_id: q.id,
            code: questionCodes[q.id] || q.starter_code || '',
            language: currentLanguage
        }));

        const timeTaken = Math.floor((Date.now() - testStartTime) / 1000);

        const response = await fetch('/technical/submit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                attempt_id: attemptId,
                solutions: solutions,
                time_taken: timeTaken
            })
        });

        const data = await response.json();

        if (data.success) {
            showSuccessModal(data.score, data.tests_passed, data.total_tests);
        } else {
            throw new Error(data.error || "Submission failed");
        }
    } catch (err) {
        console.error("‚ùå Submission failed:", err);
        alert("Failed to submit solutions. Please try again.");
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

function showSuccessModal(score, passed, total) {
    document.getElementById("modalScore").textContent = `${score}% (${passed}/${total})`;
    document.getElementById("successModal").classList.add("show");
}

function closeSuccessModal() {
    document.getElementById("successModal").classList.remove("show");
}

/* ---------- OUTPUT TABS ---------- */
function switchOutputTab(tab) {
    document.querySelectorAll('.output-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`[onclick="switchOutputTab('${tab}')"]`).classList.add('active');
}

/* ---------- MISC ---------- */
function confirmQuit() {
    if (confirm("‚ö†Ô∏è Quit the interview? Your progress will be lost.")) window.location.href = "/dashboard";
}

window.onload = initTest;
window.onbeforeunload = () => {
    if (!testCompleted && timeRemaining > 0 && questions.length > 0)
        return "‚ö†Ô∏è Interview in progress. Are you sure you want to leave?";
};
</script>
